# CloudWatch monitoring setup for EKS cluster
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudwatch-config
  namespace: amazon-cloudwatch
data:
  cwagentconfig.json: |
    {
      "logs": {
        "metrics_collected": {
          "kubernetes": {
            "cluster_name": "healthcare-cluster",
            "metrics_collection_interval": 60
          }
        },
        "force_flush_interval": 5
      },
      "metrics": {
        "namespace": "Healthcare/EKS",
        "metrics_collected": {
          "cpu": {
            "measurement": ["cpu_usage_idle", "cpu_usage_iowait", "cpu_usage_user", "cpu_usage_system"],
            "metrics_collection_interval": 60
          },
          "disk": {
            "measurement": ["used_percent"],
            "metrics_collection_interval": 60,
            "resources": ["*"]
          },
          "diskio": {
            "measurement": ["io_time", "read_bytes", "write_bytes", "reads", "writes"],
            "metrics_collection_interval": 60,
            "resources": ["*"]
          },
          "mem": {
            "measurement": ["mem_used_percent"],
            "metrics_collection_interval": 60
          },
          "netstat": {
            "measurement": ["tcp_established", "tcp_time_wait"],
            "metrics_collection_interval": 60
          },
          "swap": {
            "measurement": ["swap_used_percent"],
            "metrics_collection_interval": 60
          }
        }
      }
    }
---
# CloudWatch Insights queries for log analysis
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudwatch-insights-queries
  namespace: monitoring
data:
  error-analysis.txt: |
    fields @timestamp, @message
    | filter @message like /ERROR/
    | stats count() by bin(5m)
    | sort @timestamp desc
  
  api-performance.txt: |
    fields @timestamp, @message, @requestId
    | filter @message like /predict/
    | parse @message "duration: * ms" as duration
    | stats avg(duration), max(duration), min(duration) by bin(5m)
    | sort @timestamp desc
  
  health-check-failures.txt: |
    fields @timestamp, @message
    | filter @message like /health/ and @message like /failed/
    | stats count() by bin(1m)
    | sort @timestamp desc
---
# Container Insights metrics filters
apiVersion: v1
kind: ConfigMap
metadata:
  name: container-insights-config
  namespace: amazon-cloudwatch
data:
  performance_schema: |
    {
      "cloudWatchMetrics": [
        {
          "namespace": "Healthcare/API/Performance",
          "metricData": [
            {
              "metricName": "CPUUtilization",
              "dimensions": [
                {"name": "PodName", "value": "{pod_name}"},
                {"name": "Namespace", "value": "healthcare-api"}
              ],
              "value": "{cpu_usage_percent}"
            },
            {
              "metricName": "MemoryUtilization", 
              "dimensions": [
                {"name": "PodName", "value": "{pod_name}"},
                {"name": "Namespace", "value": "healthcare-api"}
              ],
              "value": "{memory_usage_percent}"
            }
          ]
        }
      ]
    }