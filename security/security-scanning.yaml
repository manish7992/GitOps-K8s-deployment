# Security scanning and compliance tools configuration

# Falco rules for runtime security monitoring
- rule: Healthcare API Unauthorized File Access
  desc: Detect unauthorized file access in healthcare API pods
  condition: >
    spawned_process and container and
    k8s.ns.name = "healthcare-api" and
    k8s.pod.name contains "healthcare-prediction-api" and
    (proc.name in (cat, less, more, tail, head) and fd.name contains "/etc/passwd") or
    (proc.name = "find" and proc.args contains "/")
  output: >
    Unauthorized file access in healthcare API
    (user=%user.name command=%proc.cmdline pid=%proc.pid
    file=%fd.name pod=%k8s.pod.name ns=%k8s.ns.name)
  priority: WARNING

- rule: Healthcare API Suspicious Network Activity
  desc: Detect suspicious network connections from healthcare API
  condition: >
    inbound_outbound and container and
    k8s.ns.name = "healthcare-api" and
    k8s.pod.name contains "healthcare-prediction-api" and
    not fd.sip in (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16) and
    not fd.sport in (53, 443, 80)
  output: >
    Suspicious network activity from healthcare API
    (connection=%fd.name pod=%k8s.pod.name ns=%k8s.ns.name)
  priority: WARNING

# OPA Gatekeeper constraints
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: healthcareapirequiresecuritycontext
spec:
  crd:
    spec:
      names:
        kind: HealthcareAPIRequireSecurityContext
      validation:
        openAPIV3Schema:
          type: object
          properties:
            runAsNonRoot:
              type: boolean
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package healthcareapirequiresecuritycontext
        
        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          not container.securityContext.runAsNonRoot
          msg := "Container must run as non-root user"
        }
        
        violation[{"msg": msg}] {
          not input.review.object.spec.securityContext.runAsNonRoot
          msg := "Pod must run as non-root user"
        }
---
apiVersion: config.gatekeeper.sh/v1alpha1
kind: HealthcareAPIRequireSecurityContext
metadata:
  name: healthcare-api-security-context
spec:
  match:
    - apiGroups: ["apps"]
      kinds: ["Deployment"]
      namespaces: ["healthcare-api"]
  parameters:
    runAsNonRoot: true
---
# Network security policy for egress filtering
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: healthcare-api-egress-policy
  namespace: healthcare-api
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: healthcare-prediction-api
  policyTypes:
  - Egress
  egress:
  # Allow DNS
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS to specific external services
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
  # Allow internal cluster communication
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
  # Block all other egress traffic
---
# Image security policy
apiVersion: v1
kind: ConfigMap
metadata:
  name: image-security-policy
  namespace: healthcare-api
data:
  policy.yaml: |
    apiVersion: admission.k8s.io/v1beta1
    kind: ValidatingAdmissionWebhook
    metadata:
      name: image-security-policy
    rules:
    - operations: ["CREATE", "UPDATE"]
      apiGroups: [""]
      apiVersions: ["v1"]
      resources: ["pods"]
    - operations: ["CREATE", "UPDATE"]
      apiGroups: ["apps"]
      apiVersions: ["v1"]
      resources: ["deployments", "replicasets"]
    failurePolicy: Fail
    imagePolicy:
      allowedRegistries:
        - "123456789012.dkr.ecr.us-west-2.amazonaws.com"
        - "docker.io/library"
      deniedTags:
        - "latest"
      requireDigest: true